version: '3'
tasks:
  build_pkg:
    requires:
      vars:
        - LIBRARY
        - PACKAGE
    vars:
      MATRIX: linux/amd64,linux/arm64,darwin/amd64,darwin/arm64
    cmds:
      - for: { var: MATRIX, split: ',', as: OS }
        task: build_os
        vars:
          LIBRARY: "{{.LIBRARY}}"
          PACKAGE: "{{.PACKAGE}}"
          OS: "{{.OS}}"


  build_os:
    requires:
      vars:
        - LIBRARY
        - PACKAGE
        - OS
    vars:
      GOOS:
        sh: echo {{.OS}} | cut -d'/' -f1
      GOARCH:
        sh: echo {{.OS}} | cut -d'/' -f2
    sources:
      - plugins/{{.LIBRARY}}/{{.PACKAGE}}/*.go
    generates:
      - target/{{.LIBRARY}}_{{.PACKAGE}}_{{.GOOS}}_{{.GOARCH}}.so
    cmds:
      - echo "Building {{.LIBRARY}}/{{.PACKAGE}} for {{.GOOS}}/{{.GOARCH}}"
      - go mod tidy
      - go build -buildmode=plugin -o target/{{.LIBRARY}}_{{.PACKAGE}}_{{.GOOS}}_{{.GOARCH}}.so ./plugins/{{.LIBRARY}}/{{.PACKAGE}}/*.go